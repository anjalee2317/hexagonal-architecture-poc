"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TaskLambdaHandler = void 0;
/**
 * Lambda handler adapter for the TaskUseCase input port
 */
class TaskLambdaHandler {
    constructor(taskUseCase) {
        this.taskUseCase = taskUseCase;
    }
    /**
     * Handle API Gateway events and route to appropriate use case methods
     */
    async handle(event) {
        try {
            const { httpMethod, path, body } = event;
            const pathSegments = path.split('/').filter(Boolean);
            const taskId = pathSegments.length > 1 ? pathSegments[1] : undefined;
            // Extract user information from Cognito authorizer if available
            const userInfo = this.extractUserInfo(event);
            // Create task
            if (httpMethod === 'POST' && pathSegments[0] === 'tasks' && !taskId) {
                const { title, description } = JSON.parse(body || '{}');
                if (!title) {
                    return this.errorResponse(400, 'Title is required');
                }
                const task = await this.taskUseCase.createTask(title, description || '', userInfo === null || userInfo === void 0 ? void 0 : userInfo.userId, userInfo === null || userInfo === void 0 ? void 0 : userInfo.email);
                return this.successResponse(201, task.toObject());
            }
            // Get all tasks
            if (httpMethod === 'GET' && pathSegments[0] === 'tasks' && !taskId) {
                const tasks = await this.taskUseCase.getAllTasks();
                return this.successResponse(200, tasks.map(task => task.toObject()));
            }
            // Get task by ID
            if (httpMethod === 'GET' && pathSegments[0] === 'tasks' && taskId) {
                const task = await this.taskUseCase.getTask(taskId);
                if (!task) {
                    return this.errorResponse(404, 'Task not found');
                }
                return this.successResponse(200, task.toObject());
            }
            // Update task
            if (httpMethod === 'PUT' && pathSegments[0] === 'tasks' && taskId) {
                const { title, description } = JSON.parse(body || '{}');
                const task = await this.taskUseCase.updateTask(taskId, title, description);
                if (!task) {
                    return this.errorResponse(404, 'Task not found');
                }
                return this.successResponse(200, task.toObject());
            }
            // Complete task
            if (httpMethod === 'PATCH' && pathSegments[0] === 'tasks' && taskId && pathSegments[2] === 'complete') {
                const task = await this.taskUseCase.completeTask(taskId, userInfo === null || userInfo === void 0 ? void 0 : userInfo.userId, userInfo === null || userInfo === void 0 ? void 0 : userInfo.email);
                if (!task) {
                    return this.errorResponse(404, 'Task not found');
                }
                return this.successResponse(200, task.toObject());
            }
            // Delete task
            if (httpMethod === 'DELETE' && pathSegments[0] === 'tasks' && taskId) {
                const success = await this.taskUseCase.deleteTask(taskId);
                if (!success) {
                    return this.errorResponse(404, 'Task not found');
                }
                return this.successResponse(204, null);
            }
            return this.errorResponse(404, 'Route not found');
        }
        catch (error) {
            console.error('Error handling request:', error);
            return this.errorResponse(500, 'Internal server error');
        }
    }
    /**
     * Extract user information from Cognito authorizer claims
     * @param event API Gateway event
     * @returns User information or undefined if not available
     */
    extractUserInfo(event) {
        var _a, _b;
        try {
            // Check if we have Cognito authorizer claims
            if (((_b = (_a = event.requestContext) === null || _a === void 0 ? void 0 : _a.authorizer) === null || _b === void 0 ? void 0 : _b.claims) &&
                typeof event.requestContext.authorizer.claims === 'object') {
                const claims = event.requestContext.authorizer.claims;
                // Extract user ID (sub) and email from claims
                const userId = claims.sub;
                const email = claims.email;
                if (userId && email) {
                    return { userId, email };
                }
            }
            return undefined;
        }
        catch (error) {
            console.error('Error extracting user info from claims:', error);
            return undefined;
        }
    }
    successResponse(statusCode, data) {
        return {
            statusCode,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
                'Access-Control-Allow-Methods': 'OPTIONS,POST,GET,PUT,DELETE,PATCH'
            },
            body: data ? JSON.stringify(data) : ''
        };
    }
    errorResponse(statusCode, message) {
        return {
            statusCode,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
                'Access-Control-Allow-Methods': 'OPTIONS,POST,GET,PUT,DELETE,PATCH'
            },
            body: JSON.stringify({ message })
        };
    }
}
exports.TaskLambdaHandler = TaskLambdaHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFza0xhbWJkYUhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYWRhcHRlcnMvaW4vVGFza0xhbWJkYUhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBR0E7O0dBRUc7QUFDSCxNQUFhLGlCQUFpQjtJQUM1QixZQUE2QixXQUF3QjtRQUF4QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtJQUFHLENBQUM7SUFFekQ7O09BRUc7SUFDSCxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQTJCO1FBQ3RDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQztZQUN6QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNyRCxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFFckUsZ0VBQWdFO1lBQ2hFLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFN0MsY0FBYztZQUNkLElBQUksVUFBVSxLQUFLLE1BQU0sSUFBSSxZQUFZLENBQUMsQ0FBQyxDQUFDLEtBQUssT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ3BFLE1BQU0sRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLENBQUM7Z0JBQ3hELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDWCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLG1CQUFtQixDQUFDLENBQUM7Z0JBQ3RELENBQUM7Z0JBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FDNUMsS0FBSyxFQUNMLFdBQVcsSUFBSSxFQUFFLEVBQ2pCLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxNQUFNLEVBQ2hCLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxLQUFLLENBQ2hCLENBQUM7Z0JBQ0YsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUNwRCxDQUFDO1lBRUQsZ0JBQWdCO1lBQ2hCLElBQUksVUFBVSxLQUFLLEtBQUssSUFBSSxZQUFZLENBQUMsQ0FBQyxDQUFDLEtBQUssT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ25FLE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDbkQsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN2RSxDQUFDO1lBRUQsaUJBQWlCO1lBQ2pCLElBQUksVUFBVSxLQUFLLEtBQUssSUFBSSxZQUFZLENBQUMsQ0FBQyxDQUFDLEtBQUssT0FBTyxJQUFJLE1BQU0sRUFBRSxDQUFDO2dCQUNsRSxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNwRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQ1YsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUNuRCxDQUFDO2dCQUNELE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDcEQsQ0FBQztZQUVELGNBQWM7WUFDZCxJQUFJLFVBQVUsS0FBSyxLQUFLLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLE9BQU8sSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDbEUsTUFBTSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQztnQkFDeEQsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUMzRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQ1YsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUNuRCxDQUFDO2dCQUNELE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDcEQsQ0FBQztZQUVELGdCQUFnQjtZQUNoQixJQUFJLFVBQVUsS0FBSyxPQUFPLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLE9BQU8sSUFBSSxNQUFNLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLFVBQVUsRUFBRSxDQUFDO2dCQUN0RyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUM5QyxNQUFNLEVBQ04sUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLE1BQU0sRUFDaEIsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLEtBQUssQ0FDaEIsQ0FBQztnQkFDRixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQ1YsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUNuRCxDQUFDO2dCQUNELE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDcEQsQ0FBQztZQUVELGNBQWM7WUFDZCxJQUFJLFVBQVUsS0FBSyxRQUFRLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLE9BQU8sSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDckUsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDMUQsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO29CQUNiLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztnQkFDbkQsQ0FBQztnQkFDRCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3pDLENBQUM7WUFFRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDcEQsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHlCQUF5QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2hELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztRQUMxRCxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxlQUFlLENBQUMsS0FBMkI7O1FBQ2pELElBQUksQ0FBQztZQUNILDZDQUE2QztZQUM3QyxJQUNFLENBQUEsTUFBQSxNQUFBLEtBQUssQ0FBQyxjQUFjLDBDQUFFLFVBQVUsMENBQUUsTUFBTTtnQkFDeEMsT0FBTyxLQUFLLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUMxRCxDQUFDO2dCQUNELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLE1BQWEsQ0FBQztnQkFFN0QsOENBQThDO2dCQUM5QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUMxQixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDO2dCQUUzQixJQUFJLE1BQU0sSUFBSSxLQUFLLEVBQUUsQ0FBQztvQkFDcEIsT0FBTyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQztnQkFDM0IsQ0FBQztZQUNILENBQUM7WUFFRCxPQUFPLFNBQVMsQ0FBQztRQUNuQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMseUNBQXlDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEUsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQztJQUNILENBQUM7SUFFTyxlQUFlLENBQUMsVUFBa0IsRUFBRSxJQUFTO1FBQ25ELE9BQU87WUFDTCxVQUFVO1lBQ1YsT0FBTyxFQUFFO2dCQUNQLGNBQWMsRUFBRSxrQkFBa0I7Z0JBQ2xDLDZCQUE2QixFQUFFLEdBQUc7Z0JBQ2xDLDhCQUE4QixFQUFFLDRCQUE0QjtnQkFDNUQsOEJBQThCLEVBQUUsbUNBQW1DO2FBQ3BFO1lBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtTQUN2QyxDQUFDO0lBQ0osQ0FBQztJQUVPLGFBQWEsQ0FBQyxVQUFrQixFQUFFLE9BQWU7UUFDdkQsT0FBTztZQUNMLFVBQVU7WUFDVixPQUFPLEVBQUU7Z0JBQ1AsY0FBYyxFQUFFLGtCQUFrQjtnQkFDbEMsNkJBQTZCLEVBQUUsR0FBRztnQkFDbEMsOEJBQThCLEVBQUUsNEJBQTRCO2dCQUM1RCw4QkFBOEIsRUFBRSxtQ0FBbUM7YUFDcEU7WUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDO1NBQ2xDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1SUQsOENBNElDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgVGFza1VzZUNhc2UgfSBmcm9tICcuLi8uLi9hcHBsaWNhdGlvbi9wb3J0cy9pbi9UYXNrVXNlQ2FzZSc7XG5cbi8qKlxuICogTGFtYmRhIGhhbmRsZXIgYWRhcHRlciBmb3IgdGhlIFRhc2tVc2VDYXNlIGlucHV0IHBvcnRcbiAqL1xuZXhwb3J0IGNsYXNzIFRhc2tMYW1iZGFIYW5kbGVyIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSB0YXNrVXNlQ2FzZTogVGFza1VzZUNhc2UpIHt9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBBUEkgR2F0ZXdheSBldmVudHMgYW5kIHJvdXRlIHRvIGFwcHJvcHJpYXRlIHVzZSBjYXNlIG1ldGhvZHNcbiAgICovXG4gIGFzeW5jIGhhbmRsZShldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGh0dHBNZXRob2QsIHBhdGgsIGJvZHkgfSA9IGV2ZW50O1xuICAgICAgY29uc3QgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihCb29sZWFuKTtcbiAgICAgIGNvbnN0IHRhc2tJZCA9IHBhdGhTZWdtZW50cy5sZW5ndGggPiAxID8gcGF0aFNlZ21lbnRzWzFdIDogdW5kZWZpbmVkO1xuICAgICAgXG4gICAgICAvLyBFeHRyYWN0IHVzZXIgaW5mb3JtYXRpb24gZnJvbSBDb2duaXRvIGF1dGhvcml6ZXIgaWYgYXZhaWxhYmxlXG4gICAgICBjb25zdCB1c2VySW5mbyA9IHRoaXMuZXh0cmFjdFVzZXJJbmZvKGV2ZW50KTtcbiAgICAgIFxuICAgICAgLy8gQ3JlYXRlIHRhc2tcbiAgICAgIGlmIChodHRwTWV0aG9kID09PSAnUE9TVCcgJiYgcGF0aFNlZ21lbnRzWzBdID09PSAndGFza3MnICYmICF0YXNrSWQpIHtcbiAgICAgICAgY29uc3QgeyB0aXRsZSwgZGVzY3JpcHRpb24gfSA9IEpTT04ucGFyc2UoYm9keSB8fCAne30nKTtcbiAgICAgICAgaWYgKCF0aXRsZSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLmVycm9yUmVzcG9uc2UoNDAwLCAnVGl0bGUgaXMgcmVxdWlyZWQnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc3QgdGFzayA9IGF3YWl0IHRoaXMudGFza1VzZUNhc2UuY3JlYXRlVGFzayhcbiAgICAgICAgICB0aXRsZSwgXG4gICAgICAgICAgZGVzY3JpcHRpb24gfHwgJycsIFxuICAgICAgICAgIHVzZXJJbmZvPy51c2VySWQsXG4gICAgICAgICAgdXNlckluZm8/LmVtYWlsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiB0aGlzLnN1Y2Nlc3NSZXNwb25zZSgyMDEsIHRhc2sudG9PYmplY3QoKSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEdldCBhbGwgdGFza3NcbiAgICAgIGlmIChodHRwTWV0aG9kID09PSAnR0VUJyAmJiBwYXRoU2VnbWVudHNbMF0gPT09ICd0YXNrcycgJiYgIXRhc2tJZCkge1xuICAgICAgICBjb25zdCB0YXNrcyA9IGF3YWl0IHRoaXMudGFza1VzZUNhc2UuZ2V0QWxsVGFza3MoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3VjY2Vzc1Jlc3BvbnNlKDIwMCwgdGFza3MubWFwKHRhc2sgPT4gdGFzay50b09iamVjdCgpKSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEdldCB0YXNrIGJ5IElEXG4gICAgICBpZiAoaHR0cE1ldGhvZCA9PT0gJ0dFVCcgJiYgcGF0aFNlZ21lbnRzWzBdID09PSAndGFza3MnICYmIHRhc2tJZCkge1xuICAgICAgICBjb25zdCB0YXNrID0gYXdhaXQgdGhpcy50YXNrVXNlQ2FzZS5nZXRUYXNrKHRhc2tJZCk7XG4gICAgICAgIGlmICghdGFzaykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmVycm9yUmVzcG9uc2UoNDA0LCAnVGFzayBub3QgZm91bmQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zdWNjZXNzUmVzcG9uc2UoMjAwLCB0YXNrLnRvT2JqZWN0KCkpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBVcGRhdGUgdGFza1xuICAgICAgaWYgKGh0dHBNZXRob2QgPT09ICdQVVQnICYmIHBhdGhTZWdtZW50c1swXSA9PT0gJ3Rhc2tzJyAmJiB0YXNrSWQpIHtcbiAgICAgICAgY29uc3QgeyB0aXRsZSwgZGVzY3JpcHRpb24gfSA9IEpTT04ucGFyc2UoYm9keSB8fCAne30nKTtcbiAgICAgICAgY29uc3QgdGFzayA9IGF3YWl0IHRoaXMudGFza1VzZUNhc2UudXBkYXRlVGFzayh0YXNrSWQsIHRpdGxlLCBkZXNjcmlwdGlvbik7XG4gICAgICAgIGlmICghdGFzaykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmVycm9yUmVzcG9uc2UoNDA0LCAnVGFzayBub3QgZm91bmQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zdWNjZXNzUmVzcG9uc2UoMjAwLCB0YXNrLnRvT2JqZWN0KCkpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBDb21wbGV0ZSB0YXNrXG4gICAgICBpZiAoaHR0cE1ldGhvZCA9PT0gJ1BBVENIJyAmJiBwYXRoU2VnbWVudHNbMF0gPT09ICd0YXNrcycgJiYgdGFza0lkICYmIHBhdGhTZWdtZW50c1syXSA9PT0gJ2NvbXBsZXRlJykge1xuICAgICAgICBjb25zdCB0YXNrID0gYXdhaXQgdGhpcy50YXNrVXNlQ2FzZS5jb21wbGV0ZVRhc2soXG4gICAgICAgICAgdGFza0lkLFxuICAgICAgICAgIHVzZXJJbmZvPy51c2VySWQsXG4gICAgICAgICAgdXNlckluZm8/LmVtYWlsXG4gICAgICAgICk7XG4gICAgICAgIGlmICghdGFzaykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmVycm9yUmVzcG9uc2UoNDA0LCAnVGFzayBub3QgZm91bmQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zdWNjZXNzUmVzcG9uc2UoMjAwLCB0YXNrLnRvT2JqZWN0KCkpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBEZWxldGUgdGFza1xuICAgICAgaWYgKGh0dHBNZXRob2QgPT09ICdERUxFVEUnICYmIHBhdGhTZWdtZW50c1swXSA9PT0gJ3Rhc2tzJyAmJiB0YXNrSWQpIHtcbiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IHRoaXMudGFza1VzZUNhc2UuZGVsZXRlVGFzayh0YXNrSWQpO1xuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5lcnJvclJlc3BvbnNlKDQwNCwgJ1Rhc2sgbm90IGZvdW5kJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuc3VjY2Vzc1Jlc3BvbnNlKDIwNCwgbnVsbCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiB0aGlzLmVycm9yUmVzcG9uc2UoNDA0LCAnUm91dGUgbm90IGZvdW5kJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGhhbmRsaW5nIHJlcXVlc3Q6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHRoaXMuZXJyb3JSZXNwb25zZSg1MDAsICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InKTtcbiAgICB9XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBFeHRyYWN0IHVzZXIgaW5mb3JtYXRpb24gZnJvbSBDb2duaXRvIGF1dGhvcml6ZXIgY2xhaW1zXG4gICAqIEBwYXJhbSBldmVudCBBUEkgR2F0ZXdheSBldmVudFxuICAgKiBAcmV0dXJucyBVc2VyIGluZm9ybWF0aW9uIG9yIHVuZGVmaW5lZCBpZiBub3QgYXZhaWxhYmxlXG4gICAqL1xuICBwcml2YXRlIGV4dHJhY3RVc2VySW5mbyhldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiB7IHVzZXJJZDogc3RyaW5nOyBlbWFpbDogc3RyaW5nIH0gfCB1bmRlZmluZWQge1xuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayBpZiB3ZSBoYXZlIENvZ25pdG8gYXV0aG9yaXplciBjbGFpbXNcbiAgICAgIGlmIChcbiAgICAgICAgZXZlbnQucmVxdWVzdENvbnRleHQ/LmF1dGhvcml6ZXI/LmNsYWltcyAmJlxuICAgICAgICB0eXBlb2YgZXZlbnQucmVxdWVzdENvbnRleHQuYXV0aG9yaXplci5jbGFpbXMgPT09ICdvYmplY3QnXG4gICAgICApIHtcbiAgICAgICAgY29uc3QgY2xhaW1zID0gZXZlbnQucmVxdWVzdENvbnRleHQuYXV0aG9yaXplci5jbGFpbXMgYXMgYW55O1xuICAgICAgICBcbiAgICAgICAgLy8gRXh0cmFjdCB1c2VyIElEIChzdWIpIGFuZCBlbWFpbCBmcm9tIGNsYWltc1xuICAgICAgICBjb25zdCB1c2VySWQgPSBjbGFpbXMuc3ViO1xuICAgICAgICBjb25zdCBlbWFpbCA9IGNsYWltcy5lbWFpbDtcbiAgICAgICAgXG4gICAgICAgIGlmICh1c2VySWQgJiYgZW1haWwpIHtcbiAgICAgICAgICByZXR1cm4geyB1c2VySWQsIGVtYWlsIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZXh0cmFjdGluZyB1c2VyIGluZm8gZnJvbSBjbGFpbXM6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cbiAgXG4gIHByaXZhdGUgc3VjY2Vzc1Jlc3BvbnNlKHN0YXR1c0NvZGU6IG51bWJlciwgZGF0YTogYW55KTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdPUFRJT05TLFBPU1QsR0VULFBVVCxERUxFVEUsUEFUQ0gnXG4gICAgICB9LFxuICAgICAgYm9keTogZGF0YSA/IEpTT04uc3RyaW5naWZ5KGRhdGEpIDogJydcbiAgICB9O1xuICB9XG4gIFxuICBwcml2YXRlIGVycm9yUmVzcG9uc2Uoc3RhdHVzQ29kZTogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcpOiBBUElHYXRld2F5UHJveHlSZXN1bHQge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ09QVElPTlMsUE9TVCxHRVQsUFVULERFTEVURSxQQVRDSCdcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2UgfSlcbiAgICB9O1xuICB9XG59XG4iXX0=